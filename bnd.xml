<?xml version="1.0"?>
<project name="bnd">

  <taskdef name="jarjar" classname="com.tonicsystems.jarjar.JarJarTask" classpath="${jarjar.jar}"/>
  <taskdef resource="proguard/ant/task.properties" classpath="${proguard.jar}"/>
  <taskdef resource="aQute/bnd/ant/taskdef.properties" classpath="${bnd.jar}"/>

  <target name="aopalliance">
    <mkdir dir="${build}/dist"/>
    <bnd files="aopalliance.bnd" classpath="${lib}/aopalliance-1.0.jar"/>
  </target>

  <target name="peaberry" depends="compile,aopalliance">
    <proguard>
      -libraryjars ${java.home}/lib/rt.jar
      -libraryjars ${ant.home}/lib/ant.jar
      -libraryjars ${aop.jar}
      -injars ${guice.jar}
      -outjars ${build}/dist
      -keep class !com.google.inject.internal.collect.** { *; }
      -keepattributes
      -dontobfuscate
      -dontoptimize
      -dontnote
    </proguard>
    <mkdir dir="${build}/trim"/>
    <jarjar jarfile="${build}/trim/peaberry.jar">
      <fileset dir="${build}/classes"/>
      <zipfileset src="${asm.jar}"/>
      <zipfileset src="${felix.jar}"/>
      <rule pattern="jsr166y.*" result="org.ops4j.peaberry.internal.@1"/>
      <rule pattern="org.objectweb.asm.*" result="org.ops4j.peaberry.internal.@1"/>
      <rule pattern="org.apache.felix.framework.util.ldap.*" result="org.ops4j.peaberry.util.ldap.@1"/>
      <keep pattern="org.ops4j.**"/>
    </jarjar>
    <bnd files="peaberry.bnd" classpath="${build}/trim/peaberry.jar"/>
  </target>

  <target name="director" depends="test.compile">
    <mkdir dir="${build}/test"/>
    <bnd files="director.bnd" classpath="${build}/test-classes"/>
  </target>

  <taskdef resource="net/sf/antcontrib/antcontrib.properties" classpath="${contrib.jar}"/>

  <target name="testcases" depends="director">
    <mkdir dir="${build}/test/bundles"/>
    <foreach target="test.bundle" param="test.bnd">
      <path>
        <fileset dir="${test}" includes="*.bnd"/>
      </path>
    </foreach>
  </target>

  <target name="test.bundle">
    <bnd files="${test.bnd}" output="${build}/test/bundles" classpath="${build}/test-classes"/>
  </target>

</project>
